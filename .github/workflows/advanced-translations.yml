# .github/workflows/advanced-translations.yml
name: Advanced Plugin Translations

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Ogni domenica
  workflow_dispatch:

jobs:
  translation-workflow:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gettext \
          msgfmt \
          msgmerge \
          msguniq \
          python3-lxml \
          python3-xmltodict
          
    - name: Process translations
      run: |
        python3 << 'EOF'
        import os
        import subprocess
        import json
        
        print("ðŸ”„ Starting translation processing...")
        
        # Trova tutti i file .po
        for root, dirs, files in os.walk("."):
            for file in files:
                if file.endswith(".po"):
                    po_file = os.path.join(root, file)
                    print(f"ðŸ“„ Processing: {po_file}")
                    
                    # Pulisci i duplicati
                    subprocess.run([
                        "msguniq", "--no-wrap", 
                        po_file, "-o", po_file
                    ], check=False)
                    
        print("âœ… Translation processing complete")
        EOF
        
    - name: Generate translation report
      run: |
        python3 << 'EOF'
        import os
        import json
        
        translation_stats = {
            "total_po_files": 0,
            "total_strings": 0,
            "languages": {},
            "plugins": {}
        }
        
        for root, dirs, files in os.walk("."):
            for file in files:
                if file.endswith(".po"):
                    po_path = os.path.join(root, file)
                    lang = file.split(".")[0]
                    plugin_name = root.split("/")[-3] if len(root.split("/")) >= 3 else "unknown"
                    
                    translation_stats["total_po_files"] += 1
                    
                    if lang not in translation_stats["languages"]:
                        translation_stats["languages"][lang] = 0
                    translation_stats["languages"][lang] += 1
                    
                    if plugin_name not in translation_stats["plugins"]:
                        translation_stats["plugins"][plugin_name] = []
                    translation_stats["plugins"][plugin_name].append(lang)
        
        with open("translation_report.json", "w") as f:
            json.dump(translation_stats, f, indent=2)
            
        print("ðŸ“Š Translation Report:")
        print(json.dumps(translation_stats, indent=2))
        EOF
        
    - name: Upload translation artifacts
      uses: actions/upload-artifact@v3
      with:
        name: translation-files
        path: |
          **/*.po
          **/*.mo
          **/*.pot
          translation_report.json
          
    - name: Create summary
      if: always()
      run: |
        echo "### ðŸ“‹ Translation Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Workflow completed successfully**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Processed files:**" >> $GITHUB_STEP_SUMMARY
        echo "- .po files: $(find . -name "*.po" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- .mo files: $(find . -name "*.mo" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Languages: $(find . -name "*.po" -exec basename {} .po \; | sort -u | wc -l)" >> $GITHUB_STEP_SUMMARY
